sudo: required
services:
- docker
env:
  global:
    - secure: "LmmicCMTmZlkJ/+M8xeZl8WQwFnSzwOtnOPpRrIa9te9Qu1WKv9jpwHy9ZD1DALItNkDygA5cawMAtgEusSyff3fvzOK0rqQfrqL3tGVXEfrWGRy/tV/YlrcQS6cAtUUUvFmYHWIGABFR0wED4eG35fn40ddxsh1cFMlfuAR1iA=" # Heroku
    - ML_BUILD_ENV=test
    - POSTGRES_URI="user=pguser password=pguser dbname=api-melvin host=ml_api_postgres sslmode=disable"
install:
- docker-compose build
- docker-compose up -d
script:
- until docker-compose exec database psql "$POSTGRES_URI" -c "select 1" > /dev/null
  2>&1; do sleep 2; done
- docker-compose exec api /bin/bash -ic "cd /go/src/github.com/melvin-laplanche/ml-api
  && make migration"
- docker-compose exec api /bin/bash -ic "cd /go/src/github.com/melvin-laplanche/ml-api/src
  && go test ./..."
deploy:
  - provider: script
    on: staging
    skip_cleanup: true
    script: ./deploy_staging.sh